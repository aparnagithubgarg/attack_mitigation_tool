{% extends "base.html" %}

{% block title %}XSS Attack Demo - Attack Mitigation Tool{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.25.0/themes/prism.css">
<style>
    .code-container {
        max-height: 300px;
        overflow-y: auto;
        margin-bottom: 20px;
    }
    .messages-container {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
    }
    .message {
        margin-bottom: 10px;
        padding: 10px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }
    .message-header {
        font-weight: bold;
        margin-bottom: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header bg-primary text-white">
        <h2>Cross-Site Scripting (XSS) Attack Demo</h2>
    </div>
    <div class="card-body">
        <div class="alert {% if secure_mode %}alert-success{% else %}alert-danger{% endif %} mb-4">
            <h4 class="alert-heading">Security Mode: {% if secure_mode %}Secure{% else %}Vulnerable{% endif %}</h4>
            <p>
                {% if secure_mode %}
                XSS Protection is <strong>enabled</strong>. HTML and JavaScript in messages will be escaped.
                {% else %}
                XSS Protection is <strong>disabled</strong>. The application is vulnerable to XSS attacks.
                {% endif %}
            </p>
            <form method="post" action="{{ url_for('toggle_security') }}" class="mt-2">
                <button type="submit" class="btn {% if secure_mode %}btn-outline-success{% else %}btn-outline-danger{% endif %}">
                    Switch to {% if secure_mode %}Vulnerable{% else %}Secure{% endif %} Mode
                </button>
            </form>
        </div>

        <div class="row mb-4">
            <div class="col-md-12">
                <h3>What is Cross-Site Scripting (XSS)?</h3>
                <p>
                    Cross-Site Scripting (XSS) is a client-side code injection attack where attackers inject malicious scripts
                    into websites viewed by other users. When a user accesses the compromised web page, their browser executes
                    the injected script, which can steal cookies, session tokens, or other sensitive information.
                </p>
                <p>
                    There are three main types of XSS attacks:
                </p>
                <ul>
                    <li><strong>Stored XSS</strong>: Malicious script is stored on the target server (e.g., in a database)</li>
                    <li><strong>Reflected XSS</strong>: Malicious script is reflected off a web server (e.g., in search results)</li>
                    <li><strong>DOM-based XSS</strong>: Vulnerability exists in client-side code rather than server-side code</li>
                </ul>
                <p>
                    This demo demonstrates a <strong>Stored XSS</strong> attack, where malicious JavaScript can be stored in a message
                    and executed when other users view the page.
                </p>
            </div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <h3>Messages Board</h3>
                <div class="messages-container">
                    {% for message in messages %}
                    <div class="message">
                        <div class="message-header">
                            {{ message.username }} - {{ message.created_at }}
                        </div>
                        <div class="message-content">
                            {% if secure_mode %}
                            {{ message.content }}
                            {% else %}
                            {{ message.content|safe }}
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>

                <div class="card mt-3">
                    <div class="card-header">Post a Message</div>
                    <div class="card-body">
                        <form method="post" action="{{ url_for('xss_post') }}">
                            <div class="mb-3">
                                <label for="content" class="form-label">Message Content:</label>
                                <textarea class="form-control" id="content" name="content" rows="3" required></textarea>
                                <div class="form-text">
                                    {% if secure_mode %}
                                    HTML tags will be escaped for security.
                                    {% else %}
                                    Try entering HTML or JavaScript, like: <code>&lt;script&gt;alert('XSS!');&lt;/script&gt;</code>
                                    {% endif %}
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Post Message</button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <h3>Code Comparison</h3>
                <ul class="nav nav-tabs" id="codeTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="vulnerable-tab" data-bs-toggle="tab" data-bs-target="#vulnerable" type="button" role="tab" aria-controls="vulnerable" aria-selected="true">Vulnerable Code</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="secure-tab" data-bs-toggle="tab" data-bs-target="#secure" type="button" role="tab" aria-controls="secure" aria-selected="false">Secure Code</button>
                    </li>
                </ul>
                <div class="tab-content" id="codeTabsContent">
                    <div class="tab-pane fade show active" id="vulnerable" role="tabpanel" aria-labelledby="vulnerable-tab">
                        <div class="code-container">
                            <pre><code class="language-python">{{ vulnerable_code }}</code></pre>
                        </div>
                        <div class="alert alert-danger">
                            <h5>Vulnerability Explanation:</h5>
                            <p>The vulnerable code directly inserts user input into the page without sanitization. This allows attackers to inject malicious scripts that will execute in other users' browsers.</p>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="secure" role="tabpanel" aria-labelledby="secure-tab">
                        <div class="code-container">
                            <pre><code class="language-python">{{ secure_code }}</code></pre>
                        </div>
                        <div class="alert alert-success">
                            <h5>Security Fix:</h5>
                            <p>The secure code uses HTML escaping to convert special characters to their HTML entity equivalents. This prevents browsers from interpreting the input as executable code.</p>
                            <p>For example, <code>&lt;</code> becomes <code>&amp;lt;</code>, which displays as text instead of starting an HTML tag.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Highlight code blocks
    document.addEventListener('DOMContentLoaded', function() {
        Prism.highlightAll();
    });
</script>
{% endblock %}